<!-- work in progress, would love feedback if possible -->
<style>
  .title{
    text-align: center;
    font-family: Arial, sans-serif;
    font-weight: normal;
  }
  .container {
      text-align: center;
    }
  .play {
    width: 80px;
    height: 50px;
    border-radius: 8px;
    font-size: 25px;
    background-color: #69db73;
  }
</style>
<h1 class="title">
  click play to generate a musical composition
</h1>
<div class="container">
  <button id="play" class="play">play</button>
</div>
<script src="https://tonejs.github.io/build/Tone.js"></script>
<script>
/* global Tone */

  const playbtn = document.querySelector('#play')
  let i=0
  
  /*const drum1 = new Tone.MembraneSynth().toDestination()
  function drumDownbeat() {
    drum1.triggerAttackRelease('C2', '8n')
  }*/
  function clap() {
  	const noiseSynth = new Tone.NoiseSynth({
    	volume: -10,
    	envelope: {
      	attack: 0.001,
      	decay: 0.1,
      	sustain: 0,
      	release: 0.1,
    	},
  	}).toDestination()

  	const noise = new Tone.Noise("brown")
  	noiseSynth.triggerAttackRelease("8n")
  	noise.start().stop("+0.1")
    const drum = new Tone.MembraneSynth().toDestination()
    	drum.triggerAttackRelease('C2', '8n')
	}
  
  const drum = new Tone.MembraneSynth().toDestination()
  function drumBeat() {
    drum.triggerAttackRelease('C2', '8n');
  }
  
  function beat (){
    const bn = (i % 8) + 1
    let clapBeats = [];
  	while (clapBeats.length < 3) {
    	const beatNum = Math.floor(Math.random() * 8) + 1;
    	if (!clapBeats.includes(beatNum)) {
      	clapBeats.push(beatNum);
    	}
  	}
  	if (clapBeats.includes(bn)) {
    	clap() 
    } else {drumBeat()
    }
    i++
  }
  
  function accent () {
    const bn = (i % 4) + 1
    let accentBeat = Math.floor(Math.random() * 4) + 1
    if (bn === accentBeat) {
    const synth = new Tone.Synth().toDestination();
    const frequency = Math.random() * (2000 - 1200 + 1) + 1200;
    const noteLength = ['2n', '4n', '8n', '16n'];
    const randomIndex = Math.floor(Math.random() * noteLength.length);
    let vibratoDepth, vibratoFrequency;
      let selectedNoteLength = noteLength[randomIndex];
  			if (selectedNoteLength === '2n') {
          vibratoDepth = 4;
          vibratoFrequency = 0.2;
      } else if (selectedNoteLength === '4n') {
          vibratoDepth = 3;
          vibratoFrequency = 0.3;
  		} else if (selectedNoteLength === '8n') {
        vibratoDepth = 2;
        vibratoFrequency = 0.4;
  		} else {
        vibratoDepth = 1;
        vibratoFrequency = 0.7
      }
  		const vibrato = new Tone.Vibrato(vibratoDepth, vibratoFrequency).toDestination();
  		synth.connect(vibrato)
      synth.triggerAttackRelease(frequency, noteLength[randomIndex])
    }
  }
  
  let isPlaying = false
  
  function btn () {
    if (isPlaying === false) {
      isPlaying = true
      Tone.Transport.bpm.value = 160
      Tone.Transport.timeSignature = [4, 4]
      Tone.Transport.cancel()
      Tone.Transport.scheduleRepeat(beat, '4n')
      Tone.Transport.scheduleRepeat(accent, '4n')
    	playbtn.style.backgroundColor = '#ed374f'
    	playbtn.textContent = 'stop'
      Tone.Transport.start()
  	} else {
      isPlaying = false
    	Tone.Transport.stop()
      playbtn.style.backgroundColor = '#69db73'
      playbtn.textContent = 'play'
      drum.triggerRelease()
      i=0
  	}
  } 
  
  playbtn.addEventListener('click', btn)
    
</script>
